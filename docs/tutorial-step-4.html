<!DOCTYPE html>
<html>
  <body>
    <button id="play">⏯️</button>
    <button id="stop">⏹</button>

    <script src="https://unpkg.com/helicon@0.1.0/dist/index.js"></script>
    <script id="sequenceProcessor" type="text/template">
      registerProcessor(
        'SequenceProcessor',
        class SequenceProcessor extends AudioWorkletProcessor {
          static get parameterDescriptors() {
            return [
              {
                name: 'clock',
                defaultValue: 0,
                automationRate: 'k-rate',
              },
            ];
          }
          lastClock = 0;
          position = 0;

          constructor(options) {
            super(options);
            this.sequence = options.processorOptions.sequence;
            this.port.onmessage = ({ data }) => {
              this.sequence = data;
              this.position =
                data.length === 0 ? 0 : this.position % data.length;
            };
          }

          process(
            inputs,
            [[output]],
            { clock: [clock] },
          ) {
            if (this.lastClock < 0 && clock >= 0) {
              this.position = (this.position + 1) % this.sequence.length;
            }
            this.lastClock = clock;

            output.fill(this.sequence[this.position]);

            return true;
          }
        },
      );
    </script>
    <script id="decayProcessor" type="text/template">
      registerProcessor(
        'DecayProcessor',
        class DecayProcessor extends AudioWorkletProcessor {
          static get parameterDescriptors() {
            return [
              {
                name: 'clock',
                defaultValue: 0,
                automationRate: 'k-rate',
              },
              {
                name: 'decay',
                defaultValue: 0.1,
                minValue: 0.001,
                automationRate: 'k-rate',
              }
            ];
          }
          lastClock = 0;
          value = 0;

          process(
            inputs,
            [[output]],
            { clock: [clock], decay: [decay] },
          ) {
            if (this.lastClock <= 0 && clock > 0) {
              this.value = 1;
            }
            this.lastClock = clock;

            const fallDelta = 1 / decay / sampleRate;
            for (let i = 0; i < output.length && this.value > fallDelta; i++) {
              output[i] = this.value;
              this.value -= fallDelta;
            }

            return true;
          }
        },
      );
    </script>
    <script>
      const { AudioGraph, ParamType, build } = helicon;

      // create extensions referencing our processors
      const extensions = [
        {
          type: 'SequenceNode',
          description: {
            numberOfInputs: 0,
            numberOfOutputs: 1,
            params: {
              clock: { type: ParamType.AudioParam, default: 0 },
              sequence: {
                type: ParamType.Value,
                default: [],
              },
            },
          },
          node: class SequenceNode extends AudioWorkletNode {
            constructor(context, { clock, sequence = [] }) {
              super(context, 'SequenceProcessor', {
                numberOfInputs: 0,
                numberOfOutputs: 1,
                outputChannelCount: [1],
                channelCount: 1,
                channelCountMode: 'explicit',
                channelInterpretation: 'discrete',
                processorOptions: { sequence },
                parameterValues: { clock },
              });
              this.clock = this.parameters.get('clock');
              this._seqeuence = sequence;
            }
            get sequence() {
              return this._sequence;
            }
            set sequence(sequence) {
              this._sequence = sequence;
              this.port.postMessage(new Float32Array(sequence));
            }
          },
          processor: `data:application/javascript;base64,${btoa(
            document.getElementById('sequenceProcessor').innerText,
          )}`,
        },
        // here we create the extension for our new decay node
        {
          type: 'DecayNode',
          description: {
            numberOfInputs: 0,
            numberOfOutputs: 1,
            params: {
              clock: { type: ParamType.AudioParam, default: 0 },
              decay: {
                type: ParamType.AudioParam,
                default: 0.1,
                min: 0.001,
              },
            },
          },
          node: class DecayNode extends AudioWorkletNode {
            constructor(context, { clock, decay }) {
              super(context, 'DecayProcessor', {
                numberOfInputs: 0,
                numberOfOutputs: 1,
                outputChannelCount: [1],
                channelCount: 1,
                channelCountMode: 'explicit',
                channelInterpretation: 'discrete',
                parameterValues: { clock, decay },
              });
              this.clock = this.parameters.get('clock');
              this.decay = this.parameters.get('decay');
            }
          },
          processor: `data:application/javascript;base64,${btoa(
            document.getElementById('decayProcessor').innerText,
          )}`,
        },
      ];

      // create graph playing a major 7th apreggio with a subtractive synth
      // voice
      const ag = new AudioGraph(
        build((node, edge) => {
          node('CLOCK', 'OscillatorNode', { type: 'square', frequency: 4 });
          node('SEQ', 'SequenceNode', {
            sequence: [0, 400, 700, 1100, 1200, 1100, 700, 400],
          });
          node('ENV', 'DecayNode', { decay: 0.25 });
          node('ENV_AMT', 'GainNode', { gain: 3600 });
          node('OSC', 'OscillatorNode', { type: 'sawtooth', frequency: 220 });
          node('FILT', 'BiquadFilterNode', {
            // we reduced the filter frequency so that it will mute the sound
            // when the envelope is not on
            frequency: 110,
            Q: 4,
          });
          node('DEST', 'AudioDestinationNode');

          edge('CLOCK', 0, 'SEQ', 'clock');
          edge('SEQ', 0, 'OSC', 'detune');

          edge('CLOCK', 0, 'ENV', 'clock');
          edge('ENV', 0, 'ENV_AMT', 0);
          edge('ENV_AMT', 0, 'FILT', 'detune');

          edge('OSC', 0, 'FILT', 0);
          edge('FILT', 0, 'DEST', 0);
        }, extensions),
        extensions,
      );

      // make buttons control playback
      document
        .getElementById('play')
        .addEventListener('click', () => (ag.playing ? ag.pause() : ag.play()));
      document
        .getElementById('stop')
        .addEventListener('click', () => ag.stop());
    </script>
  </body>
</html>
